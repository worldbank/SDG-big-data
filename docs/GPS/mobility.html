<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Mobility Patterns | GPS Analytics</title>
  <meta name="description" content="Guided step by step analysis of income based mobility patterns from GPS data." />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Mobility Patterns | GPS Analytics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Guided step by step analysis of income based mobility patterns from GPS data." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Mobility Patterns | GPS Analytics" />
  
  <meta name="twitter:description" content="Guided step by step analysis of income based mobility patterns from GPS data." />
  

<meta name="author" content="Chapter 6 Mobility Patterns | GPS Analytics Group" />


<meta name="date" content="2021-08-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="defining-home-and-work-locations.html"/>
<link rel="next" href="migration.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">GPS Mobility Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>2</b> Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data.html"><a href="data.html#gps-data"><i class="fa fa-check"></i><b>2.1</b> GPS Data</a></li>
<li class="chapter" data-level="2.2" data-path="data.html"><a href="data.html#wealth-index-data"><i class="fa fa-check"></i><b>2.2</b> Wealth Index Data</a></li>
<li class="chapter" data-level="2.3" data-path="data.html"><a href="data.html#administrative-boundaries-data"><i class="fa fa-check"></i><b>2.3</b> Administrative Boundaries Data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geocode.html"><a href="geocode.html"><i class="fa fa-check"></i><b>3</b> Geocode</a>
<ul>
<li class="chapter" data-level="3.1" data-path="geocode.html"><a href="geocode.html#efficient-spatial-joining-and-geospatial-indexing"><i class="fa fa-check"></i><b>3.1</b> Efficient spatial joining and Geospatial Indexing</a></li>
<li class="chapter" data-level="3.2" data-path="geocode.html"><a href="geocode.html#code"><i class="fa fa-check"></i><b>3.2</b> Code</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="geocode.html"><a href="geocode.html#loading-administrative-units"><i class="fa fa-check"></i><b>3.2.1</b> Loading administrative units</a></li>
<li class="chapter" data-level="3.2.2" data-path="geocode.html"><a href="geocode.html#loading-ping-data-and-h3-indexing"><i class="fa fa-check"></i><b>3.2.2</b> Loading ping data and h3 indexing</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="geocode.html"><a href="geocode.html#initial-coarse-geo-spatial-join-with-shapefiles"><i class="fa fa-check"></i><b>3.3</b> Initial coarse geo-spatial join with shapefiles</a></li>
<li class="chapter" data-level="3.4" data-path="geocode.html"><a href="geocode.html#final-exact-join-with-a-subset-of-the-shapefiles"><i class="fa fa-check"></i><b>3.4</b> Final exact join with a subset of the shapefiles</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="stops.html"><a href="stops.html"><i class="fa fa-check"></i><b>4</b> Finding Stops</a>
<ul>
<li class="chapter" data-level="4.1" data-path="stops.html"><a href="stops.html#definition"><i class="fa fa-check"></i><b>4.1</b> Definition</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="stops.html"><a href="stops.html#get-stop-locations"><i class="fa fa-check"></i><b>4.1.1</b> Get stop locations</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="stops.html"><a href="stops.html#clustering-recurrent-stops"><i class="fa fa-check"></i><b>4.2</b> Clustering recurrent stops</a></li>
<li class="chapter" data-level="4.3" data-path="stops.html"><a href="stops.html#appending-pings-from-recent-dates"><i class="fa fa-check"></i><b>4.3</b> Appending pings from recent dates</a></li>
<li class="chapter" data-level="4.4" data-path="stops.html"><a href="stops.html#stops-geocoding"><i class="fa fa-check"></i><b>4.4</b> Stops geocoding</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="defining-home-and-work-locations.html"><a href="defining-home-and-work-locations.html"><i class="fa fa-check"></i><b>5</b> Defining Home and Work Locations</a>
<ul>
<li class="chapter" data-level="5.1" data-path="defining-home-and-work-locations.html"><a href="defining-home-and-work-locations.html#seasonal-patterns"><i class="fa fa-check"></i><b>5.1</b> Seasonal patterns</a></li>
<li class="chapter" data-level="5.2" data-path="defining-home-and-work-locations.html"><a href="defining-home-and-work-locations.html#code-1"><i class="fa fa-check"></i><b>5.2</b> Code</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mobility.html"><a href="mobility.html"><i class="fa fa-check"></i><b>6</b> Mobility Patterns</a>
<ul>
<li class="chapter" data-level="6.1" data-path="mobility.html"><a href="mobility.html#individuals-selection"><i class="fa fa-check"></i><b>6.1</b> Individual’s selection</a></li>
<li class="chapter" data-level="6.2" data-path="mobility.html"><a href="mobility.html#measures"><i class="fa fa-check"></i><b>6.2</b> Measures</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="mobility.html"><a href="mobility.html#measuring-mobility"><i class="fa fa-check"></i><b>6.2.1</b> Measuring mobility</a></li>
<li class="chapter" data-level="6.2.2" data-path="mobility.html"><a href="mobility.html#measuring-change"><i class="fa fa-check"></i><b>6.2.2</b> Measuring change</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="migration.html"><a href="migration.html"><i class="fa fa-check"></i><b>7</b> Migration Patterns</a></li>
<li class="chapter" data-level="8" data-path="optimization.html"><a href="optimization.html"><i class="fa fa-check"></i><b>8</b> Parameter Optimization</a></li>
<li class="chapter" data-level="9" data-path="windex.html"><a href="windex.html"><i class="fa fa-check"></i><b>9</b> Wealth Index</a></li>
<li class="chapter" data-level="10" data-path="voronoi.html"><a href="voronoi.html"><i class="fa fa-check"></i><b>10</b> Voronoi</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GPS Analytics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="mobility" class="section level1" number="6">
<h1><span class="header-section-number">Chapter 6</span> Mobility Patterns</h1>
<p>Individual mobility analysis represent a key ingredient to understand and timely follow changes in their behavioural patterns. In this book we relie on heavily tested and robust GPS traces preprocessing to measure and quantify individual mobility patterns.</p>
<div id="individuals-selection" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Individual’s selection</h2>
<p>Following the preprocessing pipeline description presented in the previous sections of the book, here we introduce an additional step aiming at refinining the pool of individuals analysed. Our intent is to measure mobility patterns only for individuals whose activity level is sufficiently high to ensure a minimum level of representativeness of the data. Individuals with recods over only a small number of days cannot be considered as a complete and correct representation fairly proxying the mobility features of an individual.</p>
<p>To this extent we use the duration of each individuals records, which have been computed during the pipeline run.
The selection imposes two requirements on individuals: i) each individual should be active (i.e. should have at least one stop record) for a minimum number of days during the pre-pandemic period (which is choose to run from the beginning of January 2020 until March 15, 2020; ii) each individual should be active for a minimum fraction of days after the pre-pandemic period until the end of 2020. This selection process is obtained invoking the following python function which returns a list of the users to be included during the analyses.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="mobility.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_active_list(durations, country, activity_level):</span>
<span id="cb12-2"><a href="mobility.html#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&#39;&#39;&#39;</span></span>
<span id="cb12-3"><a href="mobility.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">  For each country invoke the following function to get a list of all active individuals.</span></span>
<span id="cb12-4"><a href="mobility.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT: dataframe with precomputed individual stops&#39; durations, country ISO code, minimum activity level required</span></span>
<span id="cb12-5"><a href="mobility.html#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    OUTPUT: list of active individuals &quot;user_id&quot;</span></span>
<span id="cb12-6"><a href="mobility.html#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">  &#39;&#39;&#39;</span></span>
<span id="cb12-7"><a href="mobility.html#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="mobility.html#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Indonesia experiences a major dropout from the service during January 2020. For this reason, a specific pre-pandemic period was adopted</span></span>
<span id="cb12-9"><a href="mobility.html#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> country <span class="op">==</span> <span class="st">&#39;ID&#39;</span>:</span>
<span id="cb12-10"><a href="mobility.html#cb12-10" aria-hidden="true" tabindex="-1"></a>      durations_2 <span class="op">=</span> durations.where(col(<span class="st">&#39;date_trunc&#39;</span>) <span class="op">&gt;=</span> <span class="st">&#39;2020-02-01&#39;</span>)</span>
<span id="cb12-11"><a href="mobility.html#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb12-12"><a href="mobility.html#cb12-12" aria-hidden="true" tabindex="-1"></a>      durations_2 <span class="op">=</span> durations</span>
<span id="cb12-13"><a href="mobility.html#cb12-13" aria-hidden="true" tabindex="-1"></a>  durations_2 <span class="op">=</span> durations_2.where(col(<span class="st">&#39;date_trunc&#39;</span>) <span class="op">&lt;</span> <span class="st">&#39;2021-01-01&#39;</span>)</span>
<span id="cb12-14"><a href="mobility.html#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="mobility.html#cb12-15" aria-hidden="true" tabindex="-1"></a>  active_days <span class="op">=</span> (durations_2</span>
<span id="cb12-16"><a href="mobility.html#cb12-16" aria-hidden="true" tabindex="-1"></a>                 .withColumn(<span class="st">&#39;pandemic&#39;</span>, F.when(col(<span class="st">&#39;date_trunc&#39;</span>) <span class="op">&lt;</span> <span class="st">&#39;2020-03-15&#39;</span>, <span class="st">&#39;pre&#39;</span>).otherwise(<span class="st">&#39;post&#39;</span>))</span>
<span id="cb12-17"><a href="mobility.html#cb12-17" aria-hidden="true" tabindex="-1"></a>                 .groupby(<span class="st">&#39;user_id&#39;</span>, <span class="st">&#39;pandemic&#39;</span>)</span>
<span id="cb12-18"><a href="mobility.html#cb12-18" aria-hidden="true" tabindex="-1"></a>                 .agg(F.countDistinct(<span class="st">&#39;date_trunc&#39;</span>).alias(<span class="st">&#39;n_days&#39;</span>)))</span>
<span id="cb12-19"><a href="mobility.html#cb12-19" aria-hidden="true" tabindex="-1"></a>  active_days.cache()</span>
<span id="cb12-20"><a href="mobility.html#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="mobility.html#cb12-21" aria-hidden="true" tabindex="-1"></a>  max_days_pre <span class="op">=</span> (active_days</span>
<span id="cb12-22"><a href="mobility.html#cb12-22" aria-hidden="true" tabindex="-1"></a>                  .where(col(<span class="st">&#39;pandemic&#39;</span>) <span class="op">==</span> <span class="st">&#39;pre&#39;</span>)</span>
<span id="cb12-23"><a href="mobility.html#cb12-23" aria-hidden="true" tabindex="-1"></a>                  .agg(F.<span class="bu">max</span>(<span class="st">&#39;n_days&#39;</span>).alias(<span class="st">&#39;max_days_pre&#39;</span>))</span>
<span id="cb12-24"><a href="mobility.html#cb12-24" aria-hidden="true" tabindex="-1"></a>                  .toPandas().loc[<span class="dv">0</span>, <span class="st">&#39;max_days_pre&#39;</span>])</span>
<span id="cb12-25"><a href="mobility.html#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="mobility.html#cb12-26" aria-hidden="true" tabindex="-1"></a>  max_days_all <span class="op">=</span> (active_days</span>
<span id="cb12-27"><a href="mobility.html#cb12-27" aria-hidden="true" tabindex="-1"></a>                  .groupby(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb12-28"><a href="mobility.html#cb12-28" aria-hidden="true" tabindex="-1"></a>                  .agg(F.<span class="bu">sum</span>(<span class="st">&#39;n_days&#39;</span>).alias(<span class="st">&#39;n_days&#39;</span>))</span>
<span id="cb12-29"><a href="mobility.html#cb12-29" aria-hidden="true" tabindex="-1"></a>                  .agg(F.<span class="bu">max</span>(<span class="st">&#39;n_days&#39;</span>).alias(<span class="st">&#39;max_days_all&#39;</span>))</span>
<span id="cb12-30"><a href="mobility.html#cb12-30" aria-hidden="true" tabindex="-1"></a>                  .toPandas().loc[<span class="dv">0</span>, <span class="st">&#39;max_days_all&#39;</span>])</span>
<span id="cb12-31"><a href="mobility.html#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="mobility.html#cb12-32" aria-hidden="true" tabindex="-1"></a>  active_users <span class="op">=</span> (active_days</span>
<span id="cb12-33"><a href="mobility.html#cb12-33" aria-hidden="true" tabindex="-1"></a>                  .groupby(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb12-34"><a href="mobility.html#cb12-34" aria-hidden="true" tabindex="-1"></a>                  .pivot(<span class="st">&#39;pandemic&#39;</span>)</span>
<span id="cb12-35"><a href="mobility.html#cb12-35" aria-hidden="true" tabindex="-1"></a>                  .agg(F.first(<span class="st">&#39;n_days&#39;</span>))</span>
<span id="cb12-36"><a href="mobility.html#cb12-36" aria-hidden="true" tabindex="-1"></a>                  .fillna(<span class="dv">0</span>)</span>
<span id="cb12-37"><a href="mobility.html#cb12-37" aria-hidden="true" tabindex="-1"></a>                  .withColumn(<span class="st">&#39;tot&#39;</span>, col(<span class="st">&#39;pre&#39;</span>)<span class="op">+</span>col(<span class="st">&#39;post&#39;</span>))</span>
<span id="cb12-38"><a href="mobility.html#cb12-38" aria-hidden="true" tabindex="-1"></a>                  .where(col(<span class="st">&#39;pre&#39;</span>) <span class="op">&gt;=</span> activity_level<span class="op">*</span>max_days_pre)</span>
<span id="cb12-39"><a href="mobility.html#cb12-39" aria-hidden="true" tabindex="-1"></a>                  .where(col(<span class="st">&#39;tot&#39;</span>) <span class="op">&gt;=</span> activity_level<span class="op">*</span>max_days_all))</span>
<span id="cb12-40"><a href="mobility.html#cb12-40" aria-hidden="true" tabindex="-1"></a>  active_days.unpersist()</span>
<span id="cb12-41"><a href="mobility.html#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="mobility.html#cb12-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> active_users</span></code></pre></div>
</div>
<div id="measures" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Measures</h2>
<div id="measuring-mobility" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Measuring mobility</h3>
</div>
<div id="measuring-change" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Measuring change</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="mobility.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> google_change_metric(df_original, start_baseline, end_baseline,other_groups<span class="op">=</span>[]):</span>
<span id="cb13-2"><a href="mobility.html#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&#39;&#39;&#39;</span></span>
<span id="cb13-3"><a href="mobility.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">  INPUT:  dataframe with (at least) 2 columns named &quot;mean&quot; and &quot;sem&quot;</span></span>
<span id="cb13-4"><a href="mobility.html#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">  OUTPUT: dataframe with the values of the two columns converted to google change metric</span></span>
<span id="cb13-5"><a href="mobility.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="al">NOTE</span><span class="co">: Google uses as baseline period the 5-weeks period from Jan 3 to Feb 6</span></span>
<span id="cb13-6"><a href="mobility.html#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">  &#39;&#39;&#39;</span></span>
<span id="cb13-7"><a href="mobility.html#cb13-7" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> df_original.copy()</span>
<span id="cb13-8"><a href="mobility.html#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="mobility.html#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute weekday baseline values</span></span>
<span id="cb13-10"><a href="mobility.html#cb13-10" aria-hidden="true" tabindex="-1"></a>  baseline <span class="op">=</span> df.loc[start_baseline:end_baseline,[<span class="st">&#39;mean&#39;</span>,<span class="st">&#39;sem&#39;</span>]<span class="op">+</span>other_groups].copy()</span>
<span id="cb13-11"><a href="mobility.html#cb13-11" aria-hidden="true" tabindex="-1"></a>  baseline[<span class="st">&#39;weekday&#39;</span>] <span class="op">=</span> <span class="bu">list</span>(baseline.index.dayofweek.values)</span>
<span id="cb13-12"><a href="mobility.html#cb13-12" aria-hidden="true" tabindex="-1"></a>  baseline <span class="op">=</span> baseline.groupby([<span class="st">&#39;weekday&#39;</span>]<span class="op">+</span>other_groups,dropna<span class="op">=</span><span class="va">False</span>,as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb13-13"><a href="mobility.html#cb13-13" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">&#39;weekday&#39;</span>] <span class="op">=</span> <span class="bu">list</span>(df.index.dayofweek.values)</span>
<span id="cb13-14"><a href="mobility.html#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="mobility.html#cb13-15" aria-hidden="true" tabindex="-1"></a>  date <span class="op">=</span> df.index.copy()</span>
<span id="cb13-16"><a href="mobility.html#cb13-16" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> df.merge(baseline, on<span class="op">=</span>[<span class="st">&#39;weekday&#39;</span>]<span class="op">+</span>other_groups, how<span class="op">=</span><span class="st">&#39;left&#39;</span>, <span class="op">=</span>(<span class="st">&#39;&#39;</span>, <span class="st">&#39;_baseline&#39;</span>))</span>
<span id="cb13-17"><a href="mobility.html#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="mobility.html#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute &quot;mean&quot; change with respect to weekday baseline values</span></span>
<span id="cb13-19"><a href="mobility.html#cb13-19" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">&#39;mean&#39;</span>] <span class="op">=</span> (df[<span class="st">&#39;mean&#39;</span>]<span class="op">-</span> df[<span class="st">&#39;mean_baseline&#39;</span>]) <span class="op">/</span> np.<span class="bu">abs</span>(df[<span class="st">&#39;mean_baseline&#39;</span>])</span>
<span id="cb13-20"><a href="mobility.html#cb13-20" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">&#39;sem&#39;</span>] <span class="op">=</span> np.<span class="bu">abs</span>(df[<span class="st">&#39;sem&#39;</span>]<span class="op">/</span>df[<span class="st">&#39;mean_baseline&#39;</span>])</span>
<span id="cb13-21"><a href="mobility.html#cb13-21" aria-hidden="true" tabindex="-1"></a>  df.index <span class="op">=</span> date</span>
<span id="cb13-22"><a href="mobility.html#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="mobility.html#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return input dataframe with &quot;mean&quot; and &quot;sem&quot; column now expressing the relative change and its error</span></span>
<span id="cb13-24"><a href="mobility.html#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df.drop([<span class="st">&#39;weekday&#39;</span>,<span class="st">&#39;mean_baseline&#39;</span>],axis<span class="op">=</span><span class="dv">1</span>,errors<span class="op">=</span><span class="st">&#39;ignore&#39;</span>)</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="defining-home-and-work-locations.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="migration.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/worldbank/SDG-big-data/tree/GPS-analytics/05-mobility.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["gps-mobility.pdf", "gps-mobility.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
